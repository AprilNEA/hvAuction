# -*- coding: utf-8 -*-
import requests
import json
from db import HVAPI
from bs4 import BeautifulSoup as bs

config = json.load(open('/conf/config.json'))
api = HVAPI(config['api_server'])
db = DATABASE(config['db'])
AUCTION_ID = 'ISK005'

HVLOGINURL = f"http://alt.hentaiverse.org/isekai/login?ipb_member_id={config['ipb_member_id']}&ipb_pass_hash={config['ipb_pass_hash']}"
session = requests.Session()
session.get(HVLOGINURL)

def accept(mid, mm_token):
    url = f'http://alt.hentaiverse.org/isekai/?s=Bazaar&ss=mm&filter=inbox&mid={mid}'
    post_data = {
        'action': 'attach_remove',
        'action_value': 0,
        'mmtoken': mm_token}
    resp = session.post(url, data=post_data)
    # resp = bs(resp.text, 'html.parser')
    # assert resp.find(id='mailform')
    # if not resp.find('img', onclick='mooglemail.remove_attachment(0)'):
    #     return True
    # else:
    #     return False

def reject(mid, mm_token):
    url = f'http://alt.hentaiverse.org/isekai/?s=Bazaar&ss=mm&filter=inbox&mid={mid}'
    resp = session.get(url)
    resp = bs(resp.text, 'html.parser')
    post_data = {
        'action': 'return_message',
        'action_value': 0,
        'mmtoken': mm_token}
    resp = session.post(url, data=post_data)
    resp = bs(resp.text, 'html.parser')
    return True


auction_mail = [{'seller': 'unikwind', 'title': '[wts] equips for auction', 'content': 'Thank you. :)', 'mmtoken': 'rlj0u3d9ngv', 'cod': 0, 'attachments': {'equips': {'Peerless Shocking Willow Staff of Destruction': 'https://hentaiverse.org/isekai/equip/596425/5a16b3bb39', 'Legendary Ruby Power Boots of Protection': 'https://hentaiverse.org/isekai/equip/477363/88394bb74f'}}, 'mid': '5507'}, {'seller': 'chjj30', 'title': 'Auction', 'content': '========== Attachment ==========\n\n25 x Crystallized Phazon\n\n================================', 'mmtoken': 'rlj0u3d9ngv', 'cod': 0, 'attachments': {'items': ['25x Crystallized Phazon']}, 'mid': '5475'}, {'seller': 'chjj30', 'title': 'Auction', 'content': '========== Attachment ==========\n\n20 x Repurposed Actuator\n\n================================', 'mmtoken': 'rlj0u3d9ngv', 'cod': 0, 'attachments': {'items': ['20x Repurposed Actuator']}, 'mid': '5474'}, {'seller': 'chjj30', 'title': 'Auction', 'content': '========== Attachment ==========\n\n25 x Defense Matrix Modulator\n\n================================', 'mmtoken': 'rlj0u3d9ngv', 'cod': 0, 'attachments': {'items': ['25x Defense Matrix Modulator']}, 'mid': '5473'}, {'seller': 'chjj30', 'title': 'Auction', 'content': '========== Attachment ==========\n\n50 x High-Grade Cloth\n\n================================', 'mmtoken': 'rlj0u3d9ngv', 'cod': 0, 'attachments': {'items': ['50x High-Grade Cloth']}, 'mid': '5472'}, '5470', {'seller': 'chjj30', 'title': 'Auction', 'content': '========== Attachment ==========\n\n200 x Scroll of Protection\n\n================================', 'mmtoken': 'rlj0u3d9ngv', 'cod': 0, 'attachments': {'items': ['200x Scroll of Protection']}, 'mid': '5469'}, {'seller': 'Jake643', 'title': 'Auction', 'content': "Hi,\n\nI'd like to send this equip for the next auction.\n\nThank you!", 'mmtoken': 'rlj0u3d9ngv', 'cod': 0, 'attachments': {'equips': {'Magnificent Phase Shoes of Niflheim': 'https://hentaiverse.org/isekai/equip/314089/ff0da269b2'}}, 'mid': '5442'}, {'seller': 'Jake643', 'title': 'Auction', 'content': "Hi,\n\nI'd like to send this equip for the next auction.\n\nThank you!", 'mmtoken': 'rlj0u3d9ngv', 'cod': 0, 'attachments': {'equips': {'Legendary Arctic Willow Staff of Destruction': 'https://hentaiverse.org/isekai/equip/247881/78eda54a88'}}, 'mid': '5441'}, {'seller': 'Jake643', 'title': 'Auction', 'content': "Hi,\n\nI'd like to send this equip for the next auction.\n\nThank you!", 'mmtoken': 'rlj0u3d9ngv', 'cod': 0, 'attachments': {'equips': {'Magnificent Phase Robe of Niflheim': 'https://hentaiverse.org/isekai/equip/272957/adb3fe266c'}}, 'mid': '5440'}, {'seller': 'Jake643', 'title': 'Auction', 'content': "Hi,\n\nI'd like to send this equip for the next auction.\n\nThank you!", 'mmtoken': 'rlj0u3d9ngv', 'cod': 0, 'attachments': {'equips': {'Magnificent Amber Force Shield of Protection': 'https://hentaiverse.org/isekai/equip/533257/a49e8c84c6'}}, 'mid': '5439'}, {'seller': 'Jake643', 'title': 'Auction', 'content': "Hi,\n\nI'd like to send this equip for the next auction.\n\nThank you!", 'mmtoken': 'rlj0u3d9ngv', 'cod': 0, 'attachments': {'equips': {'Legendary Onyx Phase Pants of Niflheim': 'https://hentaiverse.org/isekai/equip/580613/cd0aa132d9'}}, 'mid': '5438'}, {'seller': 'Jake643', 'title': 'Auction', 'content': "Hi,\n\nI'd like to send this equip for the next auction.\n\nThank you!", 'mmtoken': 'rlj0u3d9ngv', 'cod': 0, 'attachments': {'equips': {'Magnificent Phase Pants of Heimdall': 'https://hentaiverse.org/isekai/equip/593158/a94638ded2'}}, 'mid': '5437'}, {'seller': 'Jake643', 'title': 'Auction', 'content': "Hi,\n\nI'd like to send this equip for the next auction.\n\nThank you!", 'mmtoken': 'rlj0u3d9ngv', 'cod': 0, 'attachments': {'equips': {'Magnificent Charged Phase Gloves of Niflheim': 'https://hentaiverse.org/isekai/equip/595318/e6f77c1570'}}, 'mid': '5436'}, {'seller': 'Pretty anon', 'title': 'For auction-Legendary Cobalt Force Shield of Protection', 'content': 'n/t', 'mmtoken': 'rlj0u3d9ngv', 'cod': 0, 'attachments': {'equips': {'Legendary Cobalt Force Shield of Protection': 'https://hentaiverse.org/isekai/equip/595395/3bb3bdfdb4'}}, 'mid': '5435'}, {'seller': 'chjj30', 'title': 'Auction', 'content': '========== Attachment ==========\n\n80 x High-Grade Wood\n\n================================', 'mmtoken': 'rlj0u3d9ngv', 'cod': 0, 'attachments': {'items': ['80x High-Grade Wood']}, 'mid': '5425'}, {'seller': 'chjj30', 'title': 'Auction', 'content': '========== Attachment ==========\n\n100 x High-Grade Leather\n\n================================', 'mmtoken': 'rlj0u3d9ngv', 'cod': 0, 'attachments': {'items': ['100x High-Grade Leather']}, 'mid': '5408'}, {'seller': 'sharmy', 'title': 'For Auction', 'content': 'n/t', 'mmtoken': 'rlj0u3d9ngv', 'cod': 0, 'attachments': {'items': ['20x Defense Matrix Modulator']}, 'mid': '5391'}, {'seller': 'sharmy', 'title': 'For Auction', 'content': 'n/t', 'mmtoken': 'rlj0u3d9ngv', 'cod': 0, 'attachments': {'items': ['20x Repurposed Actuator']}, 'mid': '5390'}, {'seller': 'sharmy', 'title': 'For Auction', 'content': 'n/t', 'mmtoken': 'rlj0u3d9ngv', 'cod': 0, 'attachments': {'equips': {'Legendary Jade Power Gauntlets of Protection': 'https://hentaiverse.org/isekai/equip/581929/10c0de0d55'}}, 'mid': '5389'}, {'seller': 'sharmy', 'title': 'For Auction', 'content': 'n/t', 'mmtoken': 'rlj0u3d9ngv', 'cod': 0, 'attachments': {'equips': {'Legendary Zircon Phase Cap of Fenrir': 'https://hentaiverse.org/isekai/equip/585385/f68287b5e9'}}, 'mid': '5388'}, {'seller': 'sharmy', 'title': 'For Auction', 'content': 'n/t', 'mmtoken': 'rlj0u3d9ngv', 'cod': 0, 'attachments': {'equips': {'Legendary Onyx Phase Cap of Fenrir': 'https://hentaiverse.org/isekai/equip/588152/46a363f203'}}, 'mid': '5387'}, {'seller': 'Pretty anon', 'title': 'For auction-Legendary Onyx Shade Boots of the Fleet', 'content': 'Thanks!', 'mmtoken': 'rlj0u3d9ngv', 'cod': 0, 'attachments': {'equips': {'Legendary Onyx Shade Boots of the Fleet': 'https://hentaiverse.org/isekai/equip/586289/7b7aeeddca'}}, 'mid': '5371'}, {'seller': 'Jake643', 'title': 'Auction', 'content': "Hi,\n\nI'd like to send this equip for the next auction.\n\nThank you!", 'mmtoken': 'rlj0u3d9ngv', 'cod': 0, 'attachments': {'equips': {'Magnificent Onyx Power Leggings of Protection': 'https://hentaiverse.org/isekai/equip/588143/a7aac8e399'}}, 'mid': '5364'}, {'seller': 'chjj30', 'title': 'Auction', 'content': '========== Attachment ==========\n\n500 x Mid-Grade Metals\n\n================================', 'mmtoken': 'rlj0u3d9ngv', 'cod': 0, 'attachments': {'items': ['500x Mid-Grade Metals']}, 'mid': '5355'}, {'seller': '稗田阿一', 'title': 'auction', 'content': '========== Attachment ==========\n\n[516253] Legendary Onyx Phase Shoes of Niflheim\n[504816] Magnificent Radiant Phase Shoes of Mjolnir\n\n================================', 'mmtoken': 'rlj0u3d9ngv', 'cod': 0, 'attachments': {'equips': {'Legendary Onyx Phase Shoes of Niflheim': 'https://hentaiverse.org/isekai/equip/516253/ed1a5bcc38', 'Magnificent Radiant Phase Shoes of Mjolnir': 'https://hentaiverse.org/isekai/equip/504816/da82317d39'}}, 'mid': '5302'}, {'seller': 'Pretty anon', 'title': 'For auction-Legendary Ruby Power Leggings of Protection', 'content': 'Resending this one too for the same reason as the other one, thanks!', 'mmtoken': 'rlj0u3d9ngv', 'cod': 0, 'attachments': {'equips': {'Legendary Ruby Power Leggings of Protection': 'https://hentaiverse.org/isekai/equip/519667/cd1d8d4e79'}}, 'mid': '5231'}, {'seller': 'Pretty anon', 'title': 'For auction-Legendary Mithril Buckler of Warding', 'content': "Resending because I saw the test thread and they aren't there and it's been a few weeks since I sent it so just in case. Thanks!", 'mmtoken': 'rlj0u3d9ngv', 'cod': 0, 'attachments': {'equips': {'Legendary Mithril Buckler of Warding': 'https://hentaiverse.org/isekai/equip/525559/3e92dba327'}}, 'mid': '5230'}, {'seller': 'Jake643', 'title': 'Auction', 'content': 'Hi,\n\nI would like this equipment to be auctioned in the next auction.\n\nThank you.', 'mmtoken': 'rlj0u3d9ngv', 'cod': 0, 'attachments': {'equips': {'Legendary Fiery Club of Slaughter': 'https://hentaiverse.org/isekai/equip/574492/578c80da2c'}}, 'mid': '5227'}, {'seller': 'Firew', 'title': 'For the next Auction', 'content': 'Thank you!\n\n========== Attachment ==========\n\n[520895] Legendary Cobalt Force Shield of Dampening\n[296049] Legendary Onyx Phase Cap of Heimdall\n[555006] Legendary Frugal Phase Pants of Fenrir\n[499957] Legendary Jade Power Helmet of Protection\n[367917] Legendary Cobalt Power Armor of Protection\n[506192] Peerless Jade Power Leggings of Protection\n\n================================', 'mmtoken': 'rlj0u3d9ngv', 'cod': 0, 'attachments': {'equips': {'Legendary Cobalt Force Shield of Dampening': 'https://hentaiverse.org/isekai/equip/520895/b0bc6c43a8', 'Legendary Onyx Phase Cap of Heimdall': 'https://hentaiverse.org/isekai/equip/296049/ad7f552d70', 'Legendary Frugal Phase Pants of Fenrir': 'https://hentaiverse.org/isekai/equip/555006/5172e11ab3', 'Legendary Jade Power Helmet of Protection': 'https://hentaiverse.org/isekai/equip/499957/2db91bece5', 'Legendary Cobalt Power Armor of Protection': 'https://hentaiverse.org/isekai/equip/367917/41a2e64ca8', 'Peerless Jade Power Leggings of Protection': 'https://hentaiverse.org/isekai/equip/506192/ce8fce6fdc'}}, 'mid': '5208'}, {'seller': '稗田阿一', 'title': 'for auction', 'content': '========== Attachment ==========\n\n[568766] Legendary Ruby Shade Breastplate of the Fleet\n\n================================', 'mmtoken': 'rlj0u3d9ngv', 'cod': 0, 'attachments': {'equips': {'Legendary Ruby Shade Breastplate of the Fleet': 'https://hentaiverse.org/isekai/equip/568766/15a55c3aae'}}, 'mid': '5187'}, {'seller': '稗田阿一', 'title': 'auction', 'content': '========== Attachment ==========\n\n[498287] Legendary Ruby Shade Helmet of the Fleet\n\n================================', 'mmtoken': 'rlj0u3d9ngv', 'cod': 0, 'attachments': {'equips': {'Legendary Ruby Shade Helmet of the Fleet': 'https://hentaiverse.org/isekai/equip/498287/cdad4c0de2'}}, 'mid': '5186'}, {'seller': 'silverporcupine', 'title': 'Auction', 'content': '========== Attachment ==========\n\n[572302] Legendary Jade Phase Gloves of Fenrir\n\n================================', 'mmtoken': 'rlj0u3d9ngv', 'cod': 0, 'attachments': {'equips': {'Legendary Jade Phase Gloves of Fenrir': 'https://hentaiverse.org/isekai/equip/572302/0dd2feb87e'}}, 'mid': '5185'}, {'seller': 'Pretty anon', 'title': 'For auction-Legendary Mithril Plate Cuirass of Warding', 'content': 'thx', 'mmtoken': 'rlj0u3d9ngv', 'cod': 0, 'attachments': {'equips': {'Legendary Mithril Plate Cuirass of Warding': 'https://hentaiverse.org/isekai/equip/554349/dbe5d1cee1'}}, 'mid': '5089'}, {'seller': 'chikeshi', 'title': 'for isk auction', 'content': 'n/t', 'mmtoken': 'rlj0u3d9ngv', 'cod': 0, 'attachments': {'equips': {'Legendary Jade Power Helmet of Protection': 'https://hentaiverse.org/isekai/equip/549968/1093a2ecf9'}}, 'mid': '5036'}, {'seller': 'chikeshi', 'title': 'for isk auction', 'content': 'n/t', 'mmtoken': 'rlj0u3d9ngv', 'cod': 0, 'attachments': {'equips': {'Magnificent Charged Phase Pants of Heimdall': 'https://hentaiverse.org/isekai/equip/545177/778d8bc7ee'}}, 'mid': '5035'}, {'seller': 'chikeshi', 'title': 'for isk auction', 'content': '你好，請問能幫我拍賣這些東西嗎?\n另外想詢問isk拍賣大約多久會舉辦一次?\n謝謝', 'mmtoken': 'rlj0u3d9ngv', 'cod': 0, 'attachments': {'equips': {'Legendary Fiery Club of Slaughter': 'https://hentaiverse.org/isekai/equip/545084/0b6c561f8f'}}, 'mid': '5034'}, {'seller': 'silverporcupine', 'title': 'Auction', 'content': '========== Attachment ==========\n\n[536820] Legendary Cobalt Cotton Shoes of the Demon-fiend\n\n================================', 'mmtoken': 'rlj0u3d9ngv', 'cod': 0, 'attachments': {'equips': {'Legendary Cobalt Cotton Shoes of the Demon-fiend': 'https://hentaiverse.org/isekai/equip/536820/4fd6426772'}}, 'mid': '4942'}, {'seller': 'lololo16', 'title': 'Auction', 'content': 'thanks', 'mmtoken': 'rlj0u3d9ngv', 'cod': 0, 'attachments': {'equips': {'Magnificent Frugal Phase Shoes of Heimdall': 'https://hentaiverse.org/isekai/equip/474560/024c093cda'}}, 'mid': '4920'}, {'seller': 'lololo16', 'title': 'Auction', 'content': 'thanks', 'mmtoken': 'rlj0u3d9ngv', 'cod': 0, 'attachments': {'equips': {'Magnificent Radiant Phase Gloves of Fenrir': 'https://hentaiverse.org/isekai/equip/335179/d78087b14f'}}, 'mid': '4919'}, {'seller': 'chjj30', 'title': 'Auction', 'content': '========== Attachment ==========\n\n[532056] Legendary Radiant Phase Robe of Heimdall\n\n================================', 'mmtoken': 'rlj0u3d9ngv', 'cod': 0, 'attachments': {'equips': {'Legendary Radiant Phase Robe of Heimdall': 'https://hentaiverse.org/isekai/equip/532056/cfcd42ebe8'}}, 'mid': '4909'}, {'seller': 'silverporcupine', 'title': 'Auction', 'content': '========== Attachment ==========\n\n[478395] Legendary Ethereal Katana of Balance\n\n================================', 'mmtoken': 'rlj0u3d9ngv', 'cod': 0, 'attachments': {'equips': {'Legendary Ethereal Katana of Balance': 'https://hentaiverse.org/isekai/equip/478395/a74296624f'}}, 'mid': '4902'}, {'seller': 'silverporcupine', 'title': 'Auction', 'content': '========== Attachment ==========\n\n[507444] Legendary Ruby Shade Boots of the Fleet\n\n================================', 'mmtoken': 'rlj0u3d9ngv', 'cod': 0, 'attachments': {'equips': {'Legendary Ruby Shade Boots of the Fleet': 'https://hentaiverse.org/isekai/equip/507444/324e22837d'}}, 'mid': '4901'}, {'seller': 'silverporcupine', 'title': 'Auction', 'content': '========== Attachment ==========\n\n[526072] Legendary Cobalt Force Shield of Protection\n\n================================', 'mmtoken': 'rlj0u3d9ngv', 'cod': 0, 'attachments': {'equips': {'Legendary Cobalt Force Shield of Protection': 'https://hentaiverse.org/isekai/equip/526072/772c091ed7'}}, 'mid': '4900'}, {'seller': 'Pretty anon', 'title': 'For auction-Legendary Jade Power Helmet of Warding', 'content': 'Thanks!', 'mmtoken': 'rlj0u3d9ngv', 'cod': 0, 'attachments': {'equips': {'Legendary Jade Power Helmet of Warding': 'https://hentaiverse.org/isekai/equip/530523/1cb34b6d28'}}, 'mid': '4898'}, {'seller': 'chjj30', 'title': 'Auction', 'content': '========== Attachment ==========\n\n[526870] Legendary Charged Phase Shoes of Freyr\n\n================================', 'mmtoken': 'rlj0u3d9ngv', 'cod': 0, 'attachments': {'equips': {'Legendary Charged Phase Shoes of Freyr': 'https://hentaiverse.org/isekai/equip/526870/1640d66942'}}, 'mid': '4873'}, {'seller': 'chjj30', 'title': 'Auction', 'content': '========== Attachment ==========\n\n[523171] Magnificent Tempestuous Willow Staff of Destruction\n\n================================', 'mmtoken': 'rlj0u3d9ngv', 'cod': 0, 'attachments': {'equips': {'Magnificent Tempestuous Willow Staff of Destruction': 'https://hentaiverse.org/isekai/equip/523171/b1b0ca8f22'}}, 'mid': '4851'}, {'seller': 'Null2Null', 'title': 'auction', 'content': 'n/t', 'mmtoken': 'rlj0u3d9ngv', 'cod': 0, 'attachments': {'items': ['168x Mid-Grade Cloth']}, 'mid': '4765'}, {'seller': 'Null2Null', 'title': 'auction', 'content': 'n/t', 'mmtoken': 'rlj0u3d9ngv', 'cod': 0, 'attachments': {'items': ['35x High-Grade Wood']}, 'mid': '4764'}, {'seller': 'Null2Null', 'title': 'auction', 'content': 'n/t', 'mmtoken': 'rlj0u3d9ngv', 'cod': 0, 'attachments': {'items': ['28x High-Grade Metals']}, 'mid': '4763'}, {'seller': 'Null2Null', 'title': 'auction', 'content': 'n/t', 'mmtoken': 'rlj0u3d9ngv', 'cod': 0, 'attachments': {'items': ['5x Crystallized Phazon']}, 'mid': '4762'}, {'seller': 'Null2Null', 'title': 'auction', 'content': 'n/t', 'mmtoken': 'rlj0u3d9ngv', 'cod': 0, 'attachments': {'items': ['67x High-Grade Cloth']}, 'mid': '4760'}]


for mail in auction_mail:
    print(mail)
    if 'attachments' in mail:
        if 'items' in mail['attachments']:
            for item in mail['attachments']['items']:
                seller, winner, price = db.search_mat(AUCTION_ID, item)
                if price == None:
                    reject(mail['mid'],mail['mmtoken'])
                    print(f"已退回{mail['seller']}的{item}")
                else:
                    accept(mail['mid'], mail['mmtoken'])
        if 'equips' in mail['attachments']:
            for equip in mail['attachments']['equips']:
                equip_link = mail['attachments']['equips'][equip]
                seller, winner, price = db.search_equip(AUCTION_ID, equip_link)
                if price == None:
                    reject(mail['mid'],mail['mmtoken'])
                    print(f"已退回{mail['seller']}的{equip, equip_link}")
                else:
                    accept(mail['mid'], mail['mmtoken'])

